<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FINSTAT CONTACT CONVERTER</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #6366f1;
            --secondary: #0f172a;
            --bg-app: #f8fafc;
            --text-main: #1e293b;
            --text-light: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --border-radius: 16px;
        }

        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); }
        * { box-sizing: border-box; }

        /* --- INTRO --- */
        .intro-screen {
            position: fixed; inset: 0;
            background: radial-gradient(circle at top right, #4338ca, #0f172a 40%, #020617);
            color: white; z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.6s ease;
        }
        .drop-zone {
            background: rgba(255, 255, 255, 0.05); border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 20px; padding: 40px; cursor: pointer; margin-top: 40px; transition: 0.3s;
        }
        .drop-zone:hover { border-color: #818cf8; transform: translateY(-5px); }
        h1 { font-family: 'Outfit', sans-serif; font-size: 3.5rem; margin: 0; background: linear-gradient(to right, #818cf8, #c084fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; letter-spacing: -1px; }

        /* --- APP --- */
        .app-screen { display: none; min-height: 100vh; padding-bottom: 50px; }

        header {
            background: white; padding: 15px 3%; border-bottom: 1px solid #e2e8f0;
            position: sticky; top: 0; z-index: 100;
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 20px;
            box-shadow: 0 4px 15px -5px rgba(0,0,0,0.05);
        }
        .brand { font-family: 'Outfit', sans-serif; font-weight: 800; font-size: 1.4rem; background: linear-gradient(90deg, #2563eb, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .search-bar input {
            background: #f1f5f9; border: 1px solid #e2e8f0; padding: 10px 15px;
            border-radius: 10px; width: 100%; min-width: 350px; font-family: 'Inter', sans-serif;
            transition: 0.2s; font-size: 0.95rem;
        }
        .search-bar input:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); }
        
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .btn-reset { background: #fee2e2; color: var(--danger); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: 0.2s; }
        .btn-reset:hover { background: #fecaca; }

        .container { max-width: 1600px; margin: 30px auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 25px; }

        /* --- CARD --- */
        .card {
            background: white; border-radius: var(--border-radius); border: 1px solid #e2e8f0;
            padding: 25px; display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .card:hover { transform: translateY(-5px); box-shadow: 0 20px 30px -10px rgba(0, 0, 0, 0.1); border-color: #cbd5e1; z-index: 10; }

        .card.done { background: #f8fafc; opacity: 0.6; filter: grayscale(1); border: 1px dashed #cbd5e1; }
        .card.done .c-name { text-decoration: line-through; color: #94a3b8; }
        .card.done::before {
            content: "VYBAVEN√â"; position: absolute; top: 20px; right: -30px; background: #cbd5e1; color: white;
            padding: 5px 40px; transform: rotate(45deg); font-size: 0.7rem; font-weight: bold; pointer-events: none;
        }

        .c-header h2 { margin: 0 0 10px 0; font-size: 1.3rem; color: var(--secondary); font-family: 'Outfit', sans-serif; line-height: 1.3; }
        
        .badges { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 5px; }
        .tag { font-size: 0.75rem; padding: 4px 10px; border-radius: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .t-loc { background: #f1f5f9; color: #636e72; }
        .t-ico { background: #f1f5f9; color: #64748b; font-family: monospace; }
        .t-seg { background: #e0e7ff; color: #4338ca; } 
        .t-emp { background: #fff7ed; color: #c2410c; }

        /* FINANCE */
        .finance-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: #e2e8f0;
            border-radius: 10px; overflow: hidden; margin-bottom: 8px; border: 1px solid #e2e8f0;
        }
        .fin-item { background: #f8fafc; padding: 10px 15px; display: flex; flex-direction: column; gap: 2px; }
        .fin-label { font-size: 0.7rem; color: #94a3b8; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .fin-val { font-weight: 700; font-size: 1rem; color: var(--secondary); white-space: nowrap; }
        .fin-val.green { color: #166534; }
        .fin-val.red { color: #dc2626; }

        /* CONTACTS - STACKED LAYOUT */
        .data-section { display: flex; flex-direction: column; gap: 5px; margin-top: 5px; }
        
        .row { display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 6px 0; border-bottom: 1px solid #f1f5f9; }
        .row:last-child { border-bottom: none; }
        
        .row-left { display: flex; align-items: center; gap: 10px; overflow: hidden; flex: 1; }
        .icon { color: #94a3b8; font-size: 1.1rem; min-width: 20px; text-align: center; }
        .val { font-weight: 500; color: var(--text-main); font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .btn-copy { background: #f1f5f9; border: none; cursor: pointer; color: #2563eb; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; transition: 0.2s; }
        .btn-copy:hover { background: #dbeafe; transform: scale(1.1); }

        /* DROPDOWN AREA */
        .hidden-stack { 
            display: none; 
            flex-direction: column; 
            gap: 0px; 
            background: #fdfdfd;
            border-radius: 8px;
            margin-top: 5px;
        }
        .hidden-stack.show { display: flex; }

        .expand-btn {
            width: 100%; background: none; border: none; color: var(--primary); font-weight: 600; font-size: 0.8rem;
            cursor: pointer; padding: 8px; text-align: center; border-top: 1px dashed #e2e8f0; margin-top: 2px; transition: 0.2s;
        }
        .expand-btn:hover { background: #eff6ff; }

        /* NOTES */
        .note-area { margin-top: 10px; }
        .note-input {
            width: 100%; border: 1px solid #e2e8f0; background: #fff;
            border-radius: 8px; padding: 10px; font-family: 'Inter', sans-serif; font-size: 0.9rem;
            resize: vertical; min-height: 50px; transition: 0.2s; color: var(--text-main);
        }
        .note-input:focus { outline: none; border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .note-label { font-size: 0.7rem; color: #94a3b8; margin-bottom: 4px; display: block; font-weight: 700; text-transform: uppercase; }

        /* ACTIONS */
        .actions { margin-top: auto; padding-top: 20px; border-top: 1px solid #f1f5f9; display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; text-decoration: none; }
        
        .btn-check { background: white; border: 1px solid #cbd5e1; color: var(--text-main); }
        .btn-check:hover { background: #f8fafc; border-color: var(--text-light); }
        .card.done .btn-check { background: #dcfce7; color: #166534; border-color: #86efac; }

        .btn-web { background: #eff6ff; color: var(--primary); }
        .btn-web:hover { background: #e0e7ff; }
        .btn-google { background: #fff7ed; color: #c2410c; }
        .btn-google:hover { background: #ffedd5; }

        #toast { visibility: hidden; background-color: #1e293b; color: #fff; text-align: center; border-radius: 8px; padding: 12px 24px; position: fixed; z-index: 999; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 0.95rem; font-weight: 500; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.5s; }
        @keyframes fadein { from {bottom: 10px; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 10px; opacity: 0;} }
    </style>
</head>
<body>

    <div class="intro-screen" id="introScreen">
        <div style="text-align:center; max-width:600px; padding:40px; animation: fadeIn 1s;">
            <h1>FINSTAT CONTACT CONVERTER</h1>
            <p style="color: #cbd5e1; margin-top: 15px; font-size: 1.1rem;">Va≈°e d√°ta s√∫ bezpeƒçne ulo≈æen√© v prehliadaƒçi.</p>
            <div class="drop-zone" id="dropZone">
                <div style="font-size: 3rem; margin-bottom: 10px;">üìÇ</div>
                <div style="font-weight: 600; font-size: 1.2rem;">Nahrajte export z Finstatu</div>
                <div style="font-size: 0.9rem; opacity: 0.7; margin-top: 5px;">.xlsx alebo .csv</div>
            </div>
            <input type="file" id="fileInput" accept=".xlsx,.csv" style="display:none">
        </div>
        <div style="position:absolute; bottom:30px; font-size:0.8rem; color:rgba(255,255,255,0.3);">Vytvoril: Mat√∫≈° Benƒço, 2026</div>
    </div>

    <div class="app-screen" id="appScreen">
        <header>
            <div class="brand">FINSTAT <span>CONTACT CONVERTER</span></div>
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="üîç Hƒæada≈• firmu, konateƒæa, mesto, IƒåO...">
            </div>
            <div class="header-actions">
                <div style="text-align:right; font-size:0.85rem; font-weight:600; color:#64748b; line-height:1.3;">
                    <span style="color:var(--secondary); font-size:1rem;" id="count">0</span> firiem<br>
                    <span style="color:var(--success);">Vybaven√©: <span id="doneCount">0</span></span>
                </div>
                <button class="btn-reset" onclick="resetApp()" title="Vymaza≈• d√°ta a zaƒça≈• odznova">üóëÔ∏è Reset</button>
            </div>
        </header>

        <div class="container">
            <div class="grid" id="grid"></div>
            <div style="text-align:center; padding:40px; color:#94a3b8; font-size:0.8rem;">Vytvoril: Mat√∫≈° Benƒço, 2026</div>
        </div>
    </div>

    <div id="toast">Skop√≠rovan√©!</div>

<script>
    let allData = [];
    let filteredData = [];
    
    const introScreen = document.getElementById('introScreen');
    const appScreen = document.getElementById('appScreen');
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const grid = document.getElementById('grid');
    const toast = document.getElementById('toast');

    window.onload = function() {
        const savedData = localStorage.getItem('finstatDataV13');
        if (savedData) {
            try {
                const parsed = JSON.parse(savedData);
                if (parsed && parsed.length > 0) {
                    allData = parsed;
                    initApp();
                }
            } catch (e) { console.error(e); }
        }
    };

    function saveData() {
        localStorage.setItem('finstatDataV13', JSON.stringify(allData));
        updateStats();
    }

    function resetApp() {
        if(confirm("Naozaj chcete vymaza≈• d√°ta?")) {
            localStorage.removeItem('finstatDataV13');
            location.reload();
        }
    }

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.background = "rgba(255,255,255,0.15)"; });
    dropZone.addEventListener('dragleave', e => { dropZone.style.background = "rgba(255,255,255,0.05)"; });
    dropZone.addEventListener('drop', e => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', e => handleFile(e.target.files[0]));

    function handleFile(file) {
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            processData(json);
        };
        reader.readAsArrayBuffer(file);
    }

    // --- UTILS ---
    function cleanPersonName(rawStr) {
        if (!rawStr) return [];
        let persons = rawStr.split(';'); 
        return persons.map(p => p.split(',')[0].trim()).filter(n => n.length > 2);
    }

    function formatMoney(num) {
        if (!num) return 'N/A';
        let clean = String(num).replace(/\s/g, '').replace(',', '.');
        let n = parseFloat(clean);
        if (isNaN(n)) return num;
        return n.toLocaleString('sk-SK').replace(/,/g, ' '); 
    }

    function formatPhone(str) {
        if (!str) return '';
        let clean = str.replace(/[^\d+]/g, '');
        if (clean.length === 10 && clean.startsWith('02')) return clean.replace(/(\d{2})(\d{3})(\d{3})(\d{2})/, '$1 $2 $3 $4');
        if (clean.length === 10 && clean.startsWith('0')) return clean.replace(/(\d{3})(\d{3})(\d{2})(\d{2})/, '$1 $2 $3 $4'); 
        if (clean.length === 10 && clean.startsWith('09')) return clean.replace(/(\d{4})(\d{3})(\d{3})/, '$1 $2 $3');
        if (clean.startsWith('+421')) return clean.replace(/(\+421)(\d{3})(\d{3})(\d{3})/, '$1 $2 $3 $4');
        return str;
    }

    function isValidEmail(email) {
        return email.includes('@') && email.length < 50 && !email.includes(' ');
    }

    function processData(json) {
        allData = json.map((row, index) => {
            const get = (k) => {
                const found = Object.keys(row).find(key => key.toLowerCase().includes(k.toLowerCase()));
                return found ? String(row[found]).trim() : "";
            };

            let phones = new Set();
            let emails = new Set();
            let webs = new Set();

            Object.keys(row).forEach(key => {
                const val = String(row[key]).trim();
                const k = key.toLowerCase();
                if(val.length < 3 || val.toLowerCase() === 'nie') return;

                if (k.includes('tel') || k.includes('mobil')) {
                    val.split(/[;,]+/).forEach(v => {
                        const cleanV = v.trim();
                        if(cleanV.length > 3) phones.add(cleanV);
                    });
                }
                if (k.includes('mail')) { 
                    val.split(/[;,]+/).forEach(v => {
                        const cleanV = v.trim();
                        if(isValidEmail(cleanV)) emails.add(cleanV);
                    });
                }
                if (k.includes('web') || k.includes('url')) webs.add(val);
            });

            const name = get('n√°zov') || get('obchodn√© meno') || "Nezn√°ma firma";
            const city = get('mesto') || get('obec') || "";
            const district = get('okres') || "";
            const segment = get('odvetvie') || get('nace') || get('ƒçinnos≈•') || "";
            const employees = get('poƒçet zamestnancov') || get('zamestnanci') || "";
            const revenue = get('tr≈æby') || get('obrat') || "";
            const profit = get('zisk') || "";
            const ico = get('iƒço');
            
            const personRaw = get('≈°tatut√°r') || get('konateƒæ') || get('osoba') || "";
            const persons = cleanPersonName(personRaw);

            let rawWebUrl = Array.from(webs)[0] || "";
            let webUrl = rawWebUrl.split(/[;, ]+/)[0]; 
            let hasWeb = false;
            let googleLink = `https://www.google.com/search?q=${encodeURIComponent(name + " " + city + " kontakt")}`;

            if (webUrl && !webUrl.includes('@') && webUrl.length > 3) {
                if (!webUrl.startsWith('http')) webUrl = 'http://' + webUrl;
                hasWeb = true;
            }

            return {
                id: index, 
                name, city, district, segment, employees, revenue, profit, 
                persons, personRaw, ico,
                phones: Array.from(phones), 
                emails: Array.from(emails),
                webUrl, hasWeb, googleLink,
                isDone: false,
                note: "" 
            };
        });

        initApp();
        saveData();
    }

    function initApp() {
        filteredData = [...allData];
        updateStats();
        render();
        introScreen.style.transform = "translateY(-100%)";
        appScreen.style.display = "block";
    }

    function updateStats() {
        const doneCount = allData.filter(x => x.isDone).length;
        document.getElementById('count').textContent = filteredData.length;
        document.getElementById('doneCount').textContent = doneCount;
    }

    window.updateNote = function(id, value) {
        const item = allData.find(x => x.id === id);
        if(item) { item.note = value; saveData(); }
    }

    // --- HTML GENERATORS ---
    function createRowHtml(value, icon, formatter, copy = false) {
        const displayVal = formatter ? formatter(value) : value;
        return `
            <div class="row">
                <div class="row-left">
                    <span class="icon">${icon}</span> 
                    <span class="val">${displayVal}</span>
                </div>
                ${copy ? `<button class="btn-copy" onclick="copyText('${value}')" title="Kop√≠rova≈•">üìã</button>` : ''}
            </div>
        `;
    }

    function renderExpandableList(items, icon, formatter, copy = false) {
        if (!items || items.length === 0) return '';

        // LIMIT ZMENEN√ù NA 4
        const VISIBLE_LIMIT = 4;

        // Ak je 4 a menej, zobraz v≈°etky
        if (items.length <= VISIBLE_LIMIT) {
            return items.map(item => createRowHtml(item, icon, formatter, copy)).join('');
        }

        // Ak je viac ako 4
        const visibleItems = items.slice(0, VISIBLE_LIMIT).map(item => createRowHtml(item, icon, formatter, copy)).join('');
        const hiddenItems = items.slice(VISIBLE_LIMIT).map(item => createRowHtml(item, icon, formatter, copy)).join('');
        const uid = Math.random().toString(36).substr(2, 9);
        
        return `
            ${visibleItems}
            <div id="hidden-${uid}" class="hidden-stack">
                ${hiddenItems}
            </div>
            <button class="expand-btn" onclick="toggleStack('${uid}', this, ${items.length - VISIBLE_LIMIT})">
                ‚¨á Zobrazi≈• ƒèal≈°ie (${items.length - VISIBLE_LIMIT})
            </button>
        `;
    }

    window.toggleStack = function(uid, btn, count) {
        const div = document.getElementById('hidden-' + uid);
        if (div.classList.contains('show')) {
            div.classList.remove('show');
            btn.innerHTML = `‚¨á Zobrazi≈• ƒèal≈°ie (${count})`;
        } else {
            div.classList.add('show');
            btn.innerHTML = `‚¨Ü Skry≈•`;
        }
    };

    function render() {
        grid.innerHTML = "";
        const visible = filteredData.slice(0, 300);

        visible.forEach(item => {
            const card = document.createElement('div');
            card.className = `card ${item.isDone ? 'done' : ''}`;
            
            const isProfitPos = item.profit && !String(item.profit).includes('-');
            const prettyRev = formatMoney(item.revenue);
            const prettyProf = formatMoney(item.profit);

            // Generovanie sekci√≠
            const personsHtml = renderExpandableList(item.persons, 'üë§', null, false);
            const phonesHtml = renderExpandableList(item.phones, 'üìû', formatPhone, true);
            const emailsHtml = renderExpandableList(item.emails, '‚úâÔ∏è', null, true);

            card.innerHTML = `
                <div class="c-header">
                    <h2 class="c-name">${item.name}</h2>
                    <div class="badges">
                        <span class="tag t-loc">üìç ${item.city}${item.district ? ', ' + item.district : ''}</span>
                        ${item.ico ? `<span class="tag t-ico">IƒåO: ${item.ico}</span>` : ''}
                        ${item.segment ? `<span class="tag t-seg">üè≠ ${item.segment.substring(0,30)}...</span>` : ''}
                        ${item.employees ? `<span class="tag t-emp">üë• ${item.employees}</span>` : ''}
                    </div>
                </div>

                <div class="finance-grid">
                    <div class="fin-item">
                        <span class="fin-label">Tr≈æby</span>
                        <span class="fin-val">${prettyRev} ‚Ç¨</span>
                    </div>
                    <div class="fin-item">
                        <span class="fin-label">Zisk</span>
                        <span class="fin-val ${isProfitPos ? 'green' : 'red'}">${prettyProf} ‚Ç¨</span>
                    </div>
                </div>

                <div class="data-section">
                    ${personsHtml}
                    ${phonesHtml}
                    ${emailsHtml}
                </div>

                <div class="note-area">
                    <span class="note-label">Pozn√°mka</span>
                    <textarea class="note-input" placeholder="..." oninput="updateNote(${item.id}, this.value)">${item.note}</textarea>
                </div>

                <div class="actions">
                    <button class="btn btn-check" onclick="toggleStatus(${item.id})">
                        ${item.isDone ? '‚Ü©Ô∏è Vr√°ti≈•' : 'üìû Vybavi≈•'}
                    </button>
                    
                    <a href="${item.hasWeb ? item.webUrl : item.googleLink}" target="_blank" 
                       class="btn ${item.hasWeb ? 'btn-web' : 'btn-google'}">
                       ${item.hasWeb ? 'üåê Web' : 'üîç Google'}
                    </a>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    window.copyText = function(text) {
        navigator.clipboard.writeText(text).then(() => {
            toast.className = "show";
            setTimeout(() => toast.className = "", 2000);
        });
    };

    window.toggleStatus = function(id) {
        const index = allData.findIndex(x => x.id === id);
        if (index !== -1) {
            allData[index].isDone = !allData[index].isDone;
            saveData();
            
            const fIndex = filteredData.findIndex(x => x.id === id);
            if(fIndex !== -1) filteredData[fIndex].isDone = allData[index].isDone;
            
            render();
            updateStats();
        }
    };

    document.getElementById('searchInput').addEventListener('input', (e) => {
        const val = e.target.value.toLowerCase();
        filteredData = allData.filter(d => 
            d.name.toLowerCase().includes(val) || 
            d.city.toLowerCase().includes(val) || 
            d.personRaw.toLowerCase().includes(val) ||
            (d.ico && d.ico.toString().includes(val))
        );
        updateStats();
        render();
    });

    const styleSheet = document.createElement("style");
    styleSheet.innerText = `@keyframes fadeIn { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } }`;
    document.head.appendChild(styleSheet);

</script>
</body>
</html>
